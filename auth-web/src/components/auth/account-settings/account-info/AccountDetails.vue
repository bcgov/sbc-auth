<template>
  <div>
    <v-form ref="editAccountForm">
      <v-card elevation="0">
        <div class="account-label">
          <div class="nav-list-title font-weight-bold">Account Details</div>
          <div class="details">
            <div v-if="viewOnlyMode" class="view-only">
              <div class="with-change-icon">
                <div>
                  <span class="font-weight-bold">Account Name:</span>
                  {{ orgName }}
                </div>
                <div v-can:CHANGE_ORG_NAME.disable v-if="viewOnlyMode">
                  <span
                    class="primary--text cursor-pointer"
                    @click="
                      $emit('update:viewOnlyMode', {
                        component: 'account',
                        mode: false
                      })
                    "
                    data-test="btn-edit"
                  >
                    <v-icon color="primary" size="20"> mdi-pencil</v-icon>
                    Change
                  </span>
                </div>
              </div>
              <div>
                <span class="font-weight-bold">Branch/Division:</span>
                {{ branchName != '' ? branchName : '-' }}
              </div>

              <div v-if="isBusinessAccount">
                <span class="font-weight-bold">Business Type:</span>
                {{ getBusinessTypeLabel }}
              </div>

              <div v-if="isBusinessAccount">
                <span class="font-weight-bold">Business Size:</span>
                {{ getBusinessSizeLabel }}
              </div>
            </div>
            <div v-else>
              <v-radio-group
                row
                v-model="accountTypeBusiness"

              >
                <div class="business-radio">
                  <v-radio
                    label="Individual Person Name"
                    :key="false"
                    :value="false"
                    data-test="radio-individual-account-type"
                    class="px-4 py-5"
                  ></v-radio>
                  <v-radio
                    label="Business Name"
                    :key="true"
                    :value="true"
                    data-test="radio-business-account-type"
                    class="px-4 py-5"
                  ></v-radio>
                </div>
              </v-radio-group>

              <v-text-field
                filled
                label="Account Name"
                v-model="orgName"
              ></v-text-field>
              <div class="value">
                <v-text-field
                  filled
                  label="Branch/Division (Optional)"
                  v-model="branchName"
                  v-can:CHANGE_ORG_NAME.disable
                ></v-text-field>
              </div>

              <div class="value" v-if="accountTypeBusiness">
                <AccountBusinessTypePicker
                  @update:org-business-type="updateOrgBusinessType"
                  ref="accountBusinessTypePickerRef"
                ></AccountBusinessTypePicker>
              </div>

              <v-card-actions class="pt-1 pr-0">
                <v-spacer></v-spacer>
                <v-btn
                  large
                  class="save-btn px-9"
                  color="primary"
                  :loading="false"
                  aria-label="Save Account Information"
                  @click="updateDetails()"
                >
                  <span class="save-btn__label">Save</span>
                </v-btn>
                <v-btn
                  outlined
                  large
                  depressed
                  class="ml-2 px-9"
                  color="primary"
                  aria-label="Cancel Account Information"
                  @click="cancelEdit()"
                  data-test="reset-button"
                  >Cancel</v-btn
                >
              </v-card-actions>
            </div>
          </div>
        </div>
      </v-card>
    </v-form>
  </div>
</template>

<script lang="ts">
import { Component, Emit, Mixins, Prop, Watch } from 'vue-property-decorator'

import AccountBusinessTypePicker from '@/components/auth/common/AccountBusinessTypePicker.vue'
import AccountChangeMixin from '@/components/auth/mixins/AccountChangeMixin.vue'

import { Code } from '@/models/Code'
import { OrgBusinessType } from '@/models/Organization'
import { namespace } from 'vuex-class'

const CodesModule = namespace('codes')

@Component({
  components: {
    AccountBusinessTypePicker
  }
})
export default class AccountDetails extends Mixins(AccountChangeMixin) {
  @Prop({ default: null }) accountDetails: OrgBusinessType
  @Prop({ default: true }) viewOnlyMode: boolean

  @Prop({ default: false }) isBusinessAccount: boolean
  // @Prop({ default: null }) updateOrgBusinessType: any
  @CodesModule.Action('getBusinessSizeCodes')
  private readonly getBusinessSizeCodes!: () => Promise<Code[]>
  @CodesModule.Action('getBusinessTypeCodes')
  private readonly getBusinessTypeCodes!: () => Promise<Code[]>
  @CodesModule.State('businessSizeCodes')
  private readonly businessSizeCodes!: Code[]
  @CodesModule.State('businessTypeCodes')
  private readonly businessTypeCodes!: Code[]

  public orgName = ''
  public branchName = ''
  public accountTypeBusiness = true

  public orgBusinessType: OrgBusinessType = {
    businessType: '',
    businessSize: ''
  }

  $refs: {
    editAccountForm: HTMLFormElement
  }

  @Watch('isBusinessAccount')
  onAccountTypeChange (businessType) {
    this.accountTypeBusiness = businessType
  }

  @Watch('accountDetails', { deep: true })
  onAccountDetailsChange () {
    this.updateAccountDetails()
  }

  updateAccountDetails () {
    this.orgName = this.accountDetails?.name
    this.branchName = this.accountDetails?.branchName
    this.orgBusinessType.businessType = this.accountDetails?.businessType
    this.orgBusinessType.businessSize = this.accountDetails?.businessSize
    this.accountTypeBusiness = this.isBusinessAccount
  }

  get getBusinessTypeLabel () {
    return this.getCodeLabel(
      this.businessTypeCodes,
      this.orgBusinessType.businessType
    )
  }

  get getBusinessSizeLabel () {
    return this.getCodeLabel(
      this.businessSizeCodes,
      this.orgBusinessType.businessSize
    )
  }

  getCodeLabel (codeList, Code) {
    const codeArray = codeList.filter(type => type.code === Code)
    return (codeArray && codeArray[0] && codeArray[0]?.desc) || ''
  }

  // toggleEdit (value) {
  //   this.viewOnly = value
  // }

  @Emit('update:viewOnlyMode')
  cancelEdit () {
    this.updateAccountDetails()
    return {
      component: 'account',
      mode: true
    }
  }

  public updateOrgBusinessType (orgBusinessType: OrgBusinessType) {
    this.orgBusinessType = orgBusinessType
  }
  // emit to par3ent only on save click
  // taking account name  an dbrqanch from this and business type details from child component
  // arrange data and emit to parent on save click
  @Emit('update:updateAndSaveAccountDetails')
  public updateDetails () {
    return {
      name: this.orgName,
      branchName: this.branchName,
      ...this.orgBusinessType
    }
  }

  private async mounted () {
    // to show businsss type valeu neeed to get all code
    await this.getBusinessTypeCodes()
    await this.getBusinessSizeCodes()
    this.updateAccountDetails()
  }
}
</script>

<style lang="scss" scoped>
@import '$assets/scss/theme.scss';
.business-radio {
  display: flex;
  width: 90%;
  .v-radio {
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.06);
    min-width: 50%;
    border: 1px rgba(0, 0, 0, 0.06) !important;
  }

  .v-radio.theme--light.v-item--active {
    border: 1px solid var(--v-primary-base) !important;
    background-color: $BCgovInputBG !important;
  }
}
</style>
